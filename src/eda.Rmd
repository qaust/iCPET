---
title: "iCPET"
author: "Quentin Auster"
date: "2022-12-14"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=FALSE}
library(readxl)
library(tidyverse)
library(reshape2)
library(rstatix)
library(data.table)
library(ggplot2)
library(openxlsx)

```


# Paths

```{r}
out_path <- "C:/Users/qaust/OneDrive/Documents/personal/jp-lab/lab/iCPET/output/"
data_path <- "C:/Users/qaust/OneDrive/Documents/personal/jp-lab/lab/iCPET/data/"
```

# Cleaning

In general, we are interested in looking into how attributes of the clot 
correlate with hemodynamic attributes such as 
•	dead space ventilation at peak exercise (Vd/Vt);
•	efficiency of ventilation (VE/VCO2) at anaerobic threshold (AT);
•	arterial-venous oxygen difference at peak exercise (C(a-v)O2 difference);
•	Alveolar-arterial difference (P(A-a)O2);
•	mean PA pressure at peak exercise (mPAP), 
•	total pulmonary resistance at peak exercise (TPR); and 
•	cardiac output at peak exercise (CO).


```{r}
# Read data
df1 <- read_xlsx(paste0(data_path, "PE_merged (12-11-2022).xlsx"))
```

```{r}
df1$clot_burden_additive <- rowSums(select(df1, `Apical_R-S1`:`Posterior_Basal_L-S10`))
```


```{r}
# Remove NA observations
df2 <- df1[complete.cases(df1$`PE Study Number`),]
```

```{r}
cols_to_drop <- c("patient_id", "series_id", "slice_number", "DOB_str", "age_str", "date_diff", "closest_date", "Enrollment ID", "iCPET ID", "PE Study Number", "iCPET study results")

# Drop non-clinical columns
df3 <- df2 %>% select(-all_of(cols_to_drop)) %>%
  rename(
    "height_cm" = "Height (cm)", 
    "weight_kg" = "Weight (kg)", 
    "bsa" = "BSA", 
    "bmi" = "BMI", 
    "resolved" = "Resolved PE", 
    "normal_study" = "Normal Study", 
    "borderline_ph" = "Borderline PH", 
    "resting_PAH" = "Resting PAH", 
    "ePH" = "ePH", 
    "resting_HFpEF" = "Resting HFpEF", 
    "exercise_HFpEF" = "Exercise HFpEF", 
    "diff_resting_PH_exercise_HFpEF" = "Resting PH- exercise HFpEF", 
    "diff_exercise_PH_restingHFpEF" = "Exercise PH- resting HFpEF", 
    "deconditioning" = "Deconditioning", 
    "preload_insufficiency" = "Preload Insufficiency", 
    "inappropriate_02_extraction" = "Inappropriate O2 Extraction", 
    "systemic_HTN_response" = "Systemic HTN Response", 
    "approached_ventilatory_ceiling" = "Approached Ventilatory Ceiling", 
    "surpassed_ventilatory_ceiling" = "Surpassed Ventilatory Ceiling", 
    "RER" = "RER", 
    "VO2_at_AT_mL/kg/min" = "VO2 (mL/kg/min) at AT", 
    "VO2_peak_mL/kg/min" = "Peak VO2 (mL/kg/min)", 
    "VO2_est_peak_mL/kg/min" = "Estimated Peak VO2 (mL/kg/min)", 
    "VO2_percent_at_AT" = "%VO2 at AT", 
    "VO2_peak_mL/min" = "Peak VO2 (mL/min)", 
    "VO2_est_peak_mL/min" = "Estimated Peak VO2 (mL/min)", 
    "VO2_perc_peak" = "% Peak VO2", 
    "CO_perc_achieved" = "%CO Achieved", 
    "VE_VCO2_slope" = "VE/VCO2 (slope)", 
    "VE_VCO2_at_AT" = "VE/VCO2 at AT", 
    "VO2_HR_peak_perc" = "VO2/HR Peak (%)", 
    "VO2_work_slope_output" = "VO2/Work Slope Output", 
    "METS" = "METS", 
    "mPAP_measured_peak_mmHg" = "Peak  Measured mPAP (mmHg)", 
    "mPAP_calculated_peak_mmHg" = "Peak  Calculated mPAP (mmHg)", 
    "PVR_peak_WU" = "Peak  PVR (WU)", 
    "Arterial_Hb_peak" = "Peak  Arterial Hb", 
    "CaO2_peak" = "Peak  CaO2", 
    "CvO2_peak" = "Peak  CvO2", 
    "C(A-V)O2_peak" = "Peak  C(A-V)O2", 
    "P(A-a)O2_peak" = "Peak  P(A-a)O2", 
    "Fick_peak_CO" = "Peak  Fick CO", 
    "VD_VT_peak" = "Peak  VD/VT", 
    "C(A-V)O2_a_art_Hb_peak" = "Peak  C(A-V)O2 a art Hb"
  )

df3$resolved <- factor(df3$resolved, levels = c(0, 1), labels = c("Resolved", "Chronic"))
df3$Race <- factor(df3$Race, levels = c(0, 1, 2), labels = c("White", "Non-White", "Non-White"))
df3$Gender <- factor(df3$Gender, levels = c(0, 1), labels = c("Female", "Male"))

```

```{r}
num_only <- df3 %>% select_if(is.numeric)
cat_only <- df3 %>% select_if(is.factor) %>% select(-c("resolved"))
ids_only <- df3 %>% select(c("patient_name", "resolved"))

num <- cbind(ids_only, num_only)
cat <- cbind(ids_only, cat_only)

num_long <- num %>%
  reshape2::melt(id.vars = c("patient_name", "resolved"))

cat_long <- cat %>%
  reshape2::melt(id.vars = c("patient_name", "resolved"))
```

```{r}
num_means <- num_long %>% 
  group_by(variable, resolved) %>%
  summarize(n = n(),
            mean = mean(value),
            sd = sd(value),
            se = sd / sqrt(n),
            min = min(value),
            med = median(value),
            max = max(value)) %>%
  setDT() %>%
  dcast(variable ~ resolved, value.var = c("n", "mean", "sd", "se", "min", "med", "max")) %>%
  filter(!(variable %in% c("study_date", "max_date")))

num_tests <- num_long %>% 
  group_by(variable) %>%
  t_test(value ~ resolved) %>%
  add_significance()

num_sum <- merge(num_means, num_tests, by = "variable")

```

```{r}
cat_sum <- cat_long %>%
  group_by(variable, resolved, value) %>%
  summarize(n = n()) %>%
  mutate(freq = n / sum(n))
```


```{r}
wb <- createWorkbook()

addWorksheet(wb, "cat")
writeData(wb, "cat", cat_sum)

addWorksheet(wb, "num")
writeData(wb, "num", num_sum)

saveWorkbook(wb, paste0(out_path, "xl/iCPET.xlsx"), overwrite=TRUE)

```



# Graphing

```{r}
num_long %>%
  filter(variable %in% c("resolved", 
                         "VE_VCO2_at_AT", 
                         "mPAP_measured_peak_mmHg", 
                         "C(A-V)O2_peak",
                         "P(A-a)O2_peak",
                         "PVR_peak_WU", 
                         "Fick_peak_CO",
                         "VD_VT_peak")) %>%
  ggplot(aes(x = variable, 
             fill = resolved, 
             colour = resolved)) + 
  geom_density(alpha = 0.3) +
  labs(title = "Distribution of Measurements, by Resolution",
       y = "Density",
       x = "") +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank()) +
  facet_wrap(~ variable, scales = "free_y")

ggsave(paste0(out_path, "plots/measurements by resolution.png"))
```



